{% extends 'critter/_layouts/cp' %}

{% import '_includes/forms' as forms %}
{% from 'critter/macros' import configWarning %}

{% set fullPageForm = true %}

{% set selectedSubnavItem = 'sections' %}

{% block sidebar %}{% endblock %}

{% block actionButton %}
    {% if currentUser.can(craft.critter.const('PERMISSION_MANAGE_CONFIG_EDIT')) %}
        <input type="submit" class="btn submit" value="{{ 'Save'|t('app') }}">
    {% endif %}
{% endblock %}

{% block content %}

    <input type="hidden" name="action" value="{{ pluginHandle }}/config/save">
    <input type="hidden" name="pluginHandle" value="{{ pluginHandle }}">
    <input type="hidden" name="siteId" value="{{ cpSite.id }}">

    {% if not currentUser.can(craft.critter.const('PERMISSION_MANAGE_CONFIG_EDIT')) %}
        <div class="readable">
            <blockquote class="note">
                <p><strong>{{ 'Read-only mode'|t(pluginHandle) }}</strong></p>
                <p>{{ 'You have permission to view plugin configuration but not to edit it. Contact your administrator if you need to make changes.'|t(pluginHandle) }}</p>
            </blockquote>
        </div>
    {% endif %}

    <h2>{{ "Fallback CSS"|t(pluginHandle) }}</h2>

    <p>Select an entry to use for generating fallback CSS when no critical CSS is cached for a request.</p>

    {% set fallbackEntryId = craft.critter.configService.getFallbackCssEntryId(cpSite.id) %}
    {% set fallbackEntry = fallbackEntryId ? (craft.entries.id(fallbackEntryId).one() ?? null) : null %}

    {{ forms.elementSelectField({
        label: "Fallback Entry"|t(pluginHandle),
        instructions: "Choose an entry that represents your site's typical layout and styling. This will be used to generate fallback CSS when no critical CSS is available."|t(pluginHandle),
        id: 'fallback-entry',
        name: 'config[fallbackCssEntryId]',
        elementType: 'craft\\elements\\Entry',
        criteria: {
            siteId: cpSite.id,
            status: null
        },
        limit: 1,
        showSiteMenu: false,
        elements: fallbackEntry ? [fallbackEntry] : [],
        disabled: not currentUser.can(craft.critter.const('PERMISSION_MANAGE_CONFIG_EDIT')),
    }) }}

    <hr>

    <h2>{{ "Sections"|t('app') }}</h2>

    <p>For sections in <em>section</em> mode, choose an entry below that best represents the typical layout and content for that section.</p>

    {% if config.sectionSettings is defined %}
        <p class="warning has-icon">
            <span class="icon" aria-hidden="true"></span>
            <span class="visually-hidden">Warning: </span><span>{{ configWarning('sectionSettings') }}</span>
        </p>
    {% endif %}

    {% for section in sections %}

        {% set sectionConfig = sectionsConfig[section.id][cpSite.id] ?? null %}
        {% set isSingle = section.type == 'single' %}

        {% if not isSingle %}
            {% set mode = settings.sectionSettings[section.handle].mode ?? settings.defaultMode %}
            {% if mode == 'section' %}
                <div class="field">

                    {# <div class="heading">
                        <h2>{{ section.name }}</h2>
                    </div> #}

                    {% set elements = sectionConfig and sectionConfig.entryId ? [sectionConfig.getEntry()] : null %}
                    {% set canEdit = currentUser.can(craft.critter.const('PERMISSION_MANAGE_CONFIG_EDIT')) %}
                    {% set isDisabled = not canEdit or mode != 'section' %}

                    {{ forms.elementSelectField({
                        label: "'" ~ section.name ~ "' Representative Entry"|t(pluginHandle),
                        instructions: 'Select an entry that represents the typical content and layout for this section.'|t(pluginHandle),
                        id: 'section-entry-' ~ section.handle,
                        name: 'config[sections][' ~ section.id ~ '][' ~ cpSite.id ~ '][entryId]',
                        elementType: 'craft\\elements\\Entry',
                        criteria: {
                            sectionId: section.id,
                            siteId: cpSite.id,
                            status: null
                        },
                        limit: 1,
                        showSiteMenu: false,
                        elements: elements,
                        disabled: isDisabled,
                        warning: mode != 'section' ? 'This section is in "' ~ mode ~ '" mode. Representative entries are only used in "section" mode.' : null
                    }) }}

                </div>
            {% endif %}
        {% endif %}
    {% endfor %}

{% endblock %}
