{% import '_includes/forms' as forms %}

<h1>Critter Utilities</h1>

<p>Use these utilities to manage Critical CSS generation and expiration.</p>

<hr>

{# <h2>Expiration</h2> #}

<h2>Expire all critical CSS</h2>

<p>Mark all critical CSS records as expired.<br>Expired CSS will still be rendered on the page until new CSS is generated.</p>

<form class="utility" method="post" accept-charset="UTF-8">
    {{ actionInput('critter/utility/expire-all') }}
    {{ redirectInput('utilities/critter') }}
    {{ csrfInput() }}

    <input type="submit" class="btn submit" value="{{ "Expire all"|t('critter') }}">
</form>

<hr>

<h2>Expire CSS for specific entry</h2>

<p>Mark critical CSS records for a specific entry as expired.<br>Select an entry to expire all associated CSS records.</p>

<form class="utility" method="post" accept-charset="UTF-8">
    {{ actionInput('critter/utility/expire-entry') }}
    {{ redirectInput('utilities/critter') }}
    {{ csrfInput() }}

    {{ forms.elementSelectField({
        label: "Entry"|t('critter'),
        id: 'entryIds',
        name: 'entryIds',
        elementType: 'craft\\elements\\Entry',
        selectionLabel: "Choose an entry"|t('critter'),
        limit: 1,
        required: true
    }) }}

    <input type="submit" class="btn submit" value="{{ "Expire entry CSS"|t('critter') }}">
</form>

<hr>

<h2>Expire CSS for specific section</h2>

<p>Mark critical CSS records for a specific section as expired.<br>Select a section to expire all associated CSS records.</p>

<form class="utility" method="post" accept-charset="UTF-8">
    {{ actionInput('critter/utility/expire-section') }}
    {{ redirectInput('utilities/critter') }}
    {{ csrfInput() }}

    {{ forms.selectField({
        label: "Section"|t('critter'),
        id: 'sectionHandle',
        name: 'sectionHandle',
        options: craft.app.entries.allSections|filter(section => section.type != 'single')|map(section => {
            value: section.handle,
            label: section.name
        }),
        required: true
    }) }}

    <input type="submit" class="btn submit" value="{{ "Expire section CSS"|t('critter') }}">
</form>

<hr>

<h2>Regenerate expired critical CSS</h2>

<p>Queue regeneration of all expired critical CSS records.</p>

<form class="utility" method="post" accept-charset="UTF-8">
    {{ actionInput('critter/utility/regenerate-expired') }}
    {{ redirectInput('utilities/critter') }}
    {{ csrfInput() }}

    <input type="submit" class="btn submit" value="{{ "Regenerate expired"|t('critter') }}">
</form>

<hr>

<h2>Clear stuck CSS records</h2>

<p>Clear CSS generation records that are stuck due to API timeouts or failures.<br>This allows failed jobs to be retried from scratch.</p>

<form class="utility" method="post" accept-charset="UTF-8">
    {{ actionInput('critter/utility/clear-stuck') }}
    {{ redirectInput('utilities/critter') }}
    {{ csrfInput() }}

    <input type="submit" class="btn submit" value="{{ "Clear stuck records"|t('critter') }}">
</form>

<hr>

<h2>Clear Cache</h2>

<p>Clear all critical CSS data from the cache.</p>

<form class="utility" method="post" accept-charset="UTF-8">
    {{ actionInput('critter/utility/clear-cache') }}
    {{ redirectInput('utilities/critter') }}
    {{ csrfInput() }}

    <input type="submit" class="btn submit" value="{{ "Clear cache"|t('critter') }}">
</form>
